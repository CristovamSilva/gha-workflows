name: Reusable Test
on:
  workflow_call:
    inputs:
      app-directory:
        description: What folder to search for requirements.
        required: true
        type: string
      module-directory:
        description: What folder to analyze.
        required: true
        type: string
      exec-report:
        description: Where to save execution results.
        required: false
        default: exec-report.xml
        type: string
      cov-report:
        description: Where to save coverage results.
        required: false
        default: coverage.xml
        type: string

jobs:
  Test:
    runs-on: ubuntu-latest
    env:
      COV_RESULTS_ART: pytest-cov-results
      EXC_RESULTS_ART: pytest-exec-results
    steps:
      - name: Load Cache & Dependencies
        uses: cristovamsilva/python-dependencies-action@v1
        with:
          app-directory: ${{ inputs.app-directory }}

      - name: Test Module
        continue-on-error: true
        run: |
          pytest ${{ inputs.module-directory }} --cov=${{ inputs.module-directory }} --cov-report xml:${{ inputs.cov-report }} --junitxml=${{ inputs.exec-report }}
        working-directory: ${{ inputs.app-directory }}

      - name: Upload pytest execution results
        uses: actions/upload-artifact@v3
        with:
          name: $EXC_RESULTS_ART
          path: ${{ inputs.exec-report }}
        working-directory: ${{ inputs.app-directory }}

      - name: Upload pytest coverage results
        uses: actions/upload-artifact@v3
        with:
          name: $COV_RESULTS_ART
          path: ${{ inputs.cov-report }}
        working-directory: ${{ inputs.app-directory }}

      - name: Set Artifcats Key Outputs
        run: |
          echo cov-artifact=$COV_RESULTS_ART >> GITHUB_OUTPUT
          echo exc-artifact=$EXC_RESULTS_ART >> GITHUB_OUTPUT
